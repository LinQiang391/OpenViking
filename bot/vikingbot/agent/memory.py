"""Memory system for persistent agent memory."""

from pathlib import Path
from typing import Any
from vikingbot.openviking_mount.ov_server import VikingClient
import asyncio

from vikingbot.utils.helpers import ensure_dir


class MemoryStore:
    """Two-layer memory: MEMORY.md (long-term facts) + HISTORY.md (grep-searchable log)."""

    def __init__(self, workspace: Path):
        self.memory_dir = ensure_dir(workspace / "memory")
        self.memory_file = self.memory_dir / "MEMORY.md"
        self.history_file = self.memory_dir / "HISTORY.md"

    def read_long_term(self) -> str:
        if self.memory_file.exists():
            return self.memory_file.read_text(encoding="utf-8")
        return ""

    def _parse_viking_memory(self, result: Any) -> str:
        if result and len(result) > 0:
            user_memories = []
            for idx, memory in enumerate(result["user_memory"], start=1):
                user_memories.append(f"{idx}. {getattr(result, "abstract", ""),}; "
                                     f"uri: {getattr(result, "uri", "")}; "
                                     f"isDir: {getattr(result, "is_leaf", False)}; "
                                     f"related score: {getattr(result, "score", 0.0),}")
            return "\n".join(user_memories)
        return ""

    def write_long_term(self, content: str) -> None:
        self.memory_file.write_text(content, encoding="utf-8")

    def append_history(self, entry: str) -> None:
        with open(self.history_file, "a", encoding="utf-8") as f:
            f.write(entry.rstrip() + "\n\n")

    def get_memory_context(self) -> str:
        long_term = self.read_long_term()
        return f"## Long-term Memory\n{long_term}" if long_term else ""

    async def get_viking_memory_context(self, session_id: str, current_message: str, history: list[dict[str, Any]]) -> str:
        client = await VikingClient.create()
        result = await client.search_memory(current_message, session_id, history)
        if not result:
            return ""
        user_memory = self._parse_viking_memory(result["user_memory"])
        agent_memory = self._parse_viking_memory(result["agent_memory"])
        return (f"## Related openviking memories.Using tools to read more details.\n"
                f"### user memories:\n{user_memory}\n"
                f"### agent memories:\n{agent_memory}")

